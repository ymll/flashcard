<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">üìö Random Flashcards</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            transition: background 0.5s, background-color 0.5s ease;
        }

        /* --- THEME SPECIFIC BACKGROUNDS --- */

        /* Professional Theme (Default, Light Gradient) */
        .theme-pro {
            background: linear-gradient(135deg, #f0f4ff 0%, #e0f7fa 25%, #fffde7 50%, #fbe9e7 75%, #f3e5f5 100%);
        }
        /* Vibrant Kid Theme (Playful Dots) */
        .theme-kid {
            background-color: #f0fdf4; /* Light Mint Green */
            background-image: radial-gradient(#dcfce7 10%, transparent 10%), radial-gradient(#dcfce7 10%, transparent 10%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        /* Dark Theme */
        .theme-dark {
            background-color: #1a1a2e; /* Deep Navy/Indigo */
        }
        /* High Contrast (B&W) Theme */
        .theme-bw {
            background-color: #ffffff;
        }
        /* Rainbow Theme (Vibrant Gradient) */
        .theme-rainbow {
            background: linear-gradient(45deg, #fee2e2, #fbcfe8, #a5b4fc, #bae6fd, #a7f3d0);
            background-size: 400% 400%;
        }


        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .flashcard {
            min-height: 20rem; 
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .flashcard-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 1.5rem;
            /* Ensure text scales within the card */
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        .flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        /* Mobile-friendly adjustments */
        @media (max-width: 640px) {
            .flashcard {
                min-height: 15rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative theme-pro">

    <!-- TOP-LEFT CONTROLS (Home, Language, Theme) -->
    <div class="fixed top-4 left-4 z-40 flex space-x-2">
        <!-- HOME BUTTON -->
        <button id="home-button" class="w-12 h-12 flex items-center justify-center bg-white text-gray-800 rounded-full shadow-lg hover:bg-gray-100 transition duration-200 transform hover:scale-105">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor">
                <path d="M 24.960938 2.1015625 A 1.0001 1.0001 0 0 0 24.386719 2.3105469 L 1.3867188 20.210938 A 1.0001 1.0001 0 1 0 2.6132812 21.789062 L 4 20.708984 L 4 48 A 1.0001 1.0001 0 0 0 5 49 L 18.832031 49 A 1.0001 1.0001 0 0 0 19.158203 49 L 30.832031 49 A 1.0001 1.0001 0 0 0 31.158203 49 L 45 49 A 1.0001 1.0001 0 0 0 46 48 L 46 20.708984 L 47.386719 21.789062 A 1.0001 1.0001 0 1 0 48.613281 20.210938 L 25.613281 2.3105469 A 1.0001 1.0001 0 0 0 24.960938 2.1015625 z M 25 4.3671875 L 44 19.154297 L 44 47 L 32 47 L 32 29 A 1.0001 1.0001 0 0 0 31 28 L 19 28 A 1.0001 1.0001 0 0 0 18 29 L 18 47 L 6 47 L 6 19.154297 L 25 4.3671875 z M 20 30 L 30 30 L 30 47 L 20 47 L 20 30 z"></path>
            </svg>
        </button>

        <!-- LANGUAGE TOGGLE BUTTON -->
        <button id="language-toggle-button" class="w-12 h-12 flex items-center justify-center bg-white text-gray-800 rounded-full shadow-lg hover:bg-gray-100 transition duration-200 transform hover:scale-105 font-bold text-sm">
            ‰∏≠/En
        </button>

        <!-- THEME TOGGLE BUTTON -->
        <button id="theme-toggle-button" class="w-12 h-12 flex items-center justify-center bg-white text-gray-800 rounded-full shadow-lg hover:bg-gray-100 transition duration-200 transform hover:scale-105">
            <span id="theme-icon" class="text-xl">‚òÄÔ∏è</span>
        </button>
    </div>
    
    <!-- FONT SIZE CONTROLS (Fixed top-right) - CIRCULAR -->
    <div id="font-controls" class="fixed top-4 right-4 z-40 flex space-x-2">
        <!-- A- BUTTON -->
        <button id="font-smaller-button" class="w-12 h-12 flex items-center justify-center bg-white text-gray-800 text-sm font-semibold rounded-full shadow-lg hover:bg-gray-100 transition duration-200 transform hover:scale-105">
            A-
        </button>
        <!-- A+ BUTTON -->
        <button id="font-larger-button" class="w-12 h-12 flex items-center justify-center bg-white text-gray-800 text-sm font-semibold rounded-full shadow-lg hover:bg-gray-100 transition duration-200 transform hover:scale-105">
            A+
        </button>
    </div>

    <!-- Card Display Area -->
    <main id="app-container" class="w-full max-w-xl flex flex-col items-center">
        <h1 id="main-title" class="text-3xl font-bold mb-6 tracking-tight"></h1>

        <!-- Flashcard Component -->
        <div id="flashcard-wrapper" class="flashcard w-full h-80 rounded-3xl perspective-1000">
            <div id="flashcard-inner" class="flashcard-inner">
                <div id="flashcard-front" class="flashcard-front bg-white">
                    <p class="font-extrabold transition duration-300"></p>
                </div>
                <div id="flashcard-back" class="flashcard-back">
                    <p class="transition duration-300"></p>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div id="controls" class="mt-8 flex space-x-4">
            <button id="start-button" class="px-6 py-3 font-semibold rounded-xl shadow-lg transition duration-200 transform hover:scale-105"></button>
            <button id="edit-button" class="px-6 py-3 font-semibold rounded-xl shadow-md transition duration-200 transform hover:scale-105"></button>
        </div>

        <!-- Progress Indicator / Message Box -->
        <p id="progress-indicator" class="mt-4 text-sm opacity-0 transition duration-300"></p>
    </main>

    <!-- Completion Screen (Hidden by default) -->
    <div id="completion-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl w-full max-w-md">
        <div id="completion-icon" class="text-6xl mb-4" role="img" aria-label="Celebration"></div>
        <h2 id="completion-title" class="text-4xl font-extrabold mb-3"></h2>
        <p id="completion-text" class="text-xl text-gray-700 mb-8"></p>
        
        <!-- Updated button layout for the completion screen -->
        <div class="flex flex-col space-y-4">
            <button id="try-again-button" class="px-8 py-4 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-105"></button>
            <button id="start-over-button" class="px-8 py-4 font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-105"></button>
        </div>
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-6 md:p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <p id="modal-instruction" class="text-sm text-gray-500 mb-4"></p>
            <textarea id="edit-textarea" class="w-full h-64 p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150 text-base" placeholder="Example: ÁîüÊ∞£ | üò°"></textarea>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="save-button" class="px-5 py-2 text-white font-semibold rounded-xl transition duration-200"></button>
                <button id="cancel-button" class="px-5 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-200"></button>
            </div>
        </div>
    </div>

    <!-- Share Modal (Hidden by default) -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-6 md:p-8 w-full max-w-sm shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="share-modal-title"></h2>
            <div id="share-options" class="space-y-3">
                <!-- Share Option Buttons will be injected here -->
            </div>
            <div class="mt-6">
                <button id="close-share-modal-button" class="w-full px-5 py-2 text-white font-semibold rounded-xl transition duration-200 bg-gray-400 hover:bg-gray-500"></button>
            </div>
        </div>
    </div>

    <!-- SHARE BUTTON (Fixed bottom-right, circle, icon-only) -->
    <button id="share-button" class="fixed bottom-6 right-6 z-40 w-14 h-14 flex items-center justify-center text-white rounded-full shadow-xl transition duration-200 transform hover:scale-110"></button>

    <script>
        // --- CONSTANTS AND STATE ---
        const STORAGE_KEY = 'simpleFlashcards';
        const FONT_SIZE_KEY = 'flashcardFontSize'; 
        const LANG_KEY = 'flashcardLanguage';
        const THEME_KEY = 'flashcardTheme';
        const CARD_TRANSITION_TIME_MS = 650;
        
        // Font size control constants
        const BASE_FONT_SIZE_PX = 36;
        const DEFINITION_OFFSET_PX = 8;
        const FONT_STEP_PX = 4;
        const MIN_FONT_SIZE_PX = 24;
        const MAX_FONT_SIZE_PX = 60;
        
        let cards = [];
        let shuffledIndices = [];
        let currentCardIndex = -1;
        let isFlipped = false;
        let currentTermFontSize = BASE_FONT_SIZE_PX; 
        
        let currentLanguage = 'en'; // 'en' or 'zh-TW'
        let currentTheme = 'pro'; // 'pro', 'kid', 'dark', 'bw', or 'rainbow'
        const THEME_CYCLE = ['pro', 'kid', 'dark', 'bw', 'rainbow'];


        const DEFAULT_CARDS = [
            { term: 'ÁîüÊ∞£', definition: 'üò°' },
            { term: 'ÂÆ≥ÊÄï', definition: 'üò®' },
            { term: 'È´òËàà', definition: 'üòÑ' },
            { term: 'ÊúüÂæÖ', definition: 'ü§©' },
            { term: 'Â§±Êúõ', definition: 'üòû' }
        ];

        // --- TRANSLATIONS (Updated to Traditional Chinese - zh-TW) ---
        const translations = {
            'en': {
                'title': 'Simple Flashcards üìö',
                'main-title': 'Welcome! Ready to learn?',
                'card-launch-start': 'Click to start',
                'card-launch-loaded': 'cards loaded',
                'button-start': 'Start Review',
                'button-edit': 'Edit Cards',
                'progress-indicator-card': 'Card',
                'progress-indicator-of': 'of',
                'completion-title': 'Great Job!',
                'completion-text': 'You successfully reviewed all the cards.',
                'button-try-again': 'Try Again',
                'modal-title': 'Edit Flashcards (Term | Definition)',
                'modal-instruction': 'Enter one flashcard per line, separating the Term (Front page) and Definition (Back page) with a single vertical pipe `|`.',
                'button-save': 'Save Cards',
                'button-cancel': 'Cancel',
                'msg-copy-success': 'Share link copied to clipboard!',
                'msg-copy-fail': 'Failed to copy link.',
                'err-empty-share': 'Cannot share an empty list. Please add cards first.',
                'err-empty-cards': 'Please add cards in the Edit Cards menu.',
                'msg-invalid-skipped-1': 'line(s) were invalid and skipped.',
                'msg-success-loaded-1': 'Successfully loaded',
                'msg-success-loaded-2': 'cards.',
                'err-min-cards': 'You must enter at least one valid flashcard (Term | Definition).',
                // --- Sharing additions ---
                'share-modal-title': 'Share Your Cards',
                'share-message': 'Check out these flashcards I created! Click the link to review them: ',
                'share-copy': 'Copy Link',
                'share-whatsapp': 'Share via WhatsApp',
                'share-signal': 'Share via Signal',
                'share-sms': 'Share via SMS',
                'share-facebook': 'Share via Facebook',
                'share-telegram': 'Share via Telegram',
                'button-close': 'Close'
            },
            'zh-TW': {
                'title': 'Á∞°ÂñÆË™çÂ≠óÂç° üìö',
                'main-title': 'Ê≠°Ëøé! Ê∫ñÂÇôÂ•ΩÂ≠∏Áøí‰∫ÜÂóé?',
                'card-launch-start': 'ÈªûÊìäÈñãÂßã',
                'card-launch-loaded': 'ÂºµÂç°Â∑≤ËºâÂÖ•',
                'button-start': 'ÈñãÂßãÂõûÈ°ß',
                'button-edit': 'Á∑®ËºØÂç°Áâá',
                'progress-indicator-card': 'Âç°Áâá',
                'progress-indicator-of': 'ÂÖ±',
                'completion-title': 'Â§™Ê£í‰∫Ü!',
                'completion-text': 'ÊÇ®Â∑≤ÊàêÂäüÂõûÈ°ßÊâÄÊúâÂç°Áâá„ÄÇ',
                'button-try-again': 'ÂÜç‰æÜ‰∏ÄÊ¨°',
                'modal-title': 'Á∑®ËºØË™çÂ≠óÂç° (Ë°ìË™û | ÂÆöÁæ©)',
                'modal-instruction': 'ÊØèË°åËº∏ÂÖ•‰∏ÄÂºµË™çÂ≠óÂç°ÔºåË´ã‰ΩøÁî® `|` Á¨¶ËôüÂàÜÈöîË°ìË™ûÔºàÂç°ÁâáÊ≠£Èù¢ÔºâÂíåÂÆöÁæ©ÔºàÂç°ÁâáËÉåÈù¢Ôºâ„ÄÇ',
                'button-save': 'ÂÑ≤Â≠òÂç°Áâá',
                'button-cancel': 'ÂèñÊ∂à',
                'msg-copy-success': 'ÂàÜ‰∫´ÈÄ£ÁµêÂ∑≤Ë§áË£Ω!',
                'msg-copy-fail': 'Ë§áË£ΩÈÄ£ÁµêÂ§±Êïó„ÄÇ',
                'err-empty-share': 'ÁÑ°Ê≥ïÂàÜ‰∫´Á©∫ÂàóË°®„ÄÇË´ãÂÖàÊñ∞Â¢ûÂç°Áâá„ÄÇ',
                'err-empty-cards': 'Ë´ãÂú®Á∑®ËºØÂç°ÁâáÈÅ∏ÂñÆ‰∏≠Êñ∞Â¢ûÂç°Áâá„ÄÇ',
                'msg-invalid-skipped-1': 'Ë°åÁÑ°Êïà‰∏¶Â∑≤Ë∑≥ÈÅé„ÄÇ',
                'msg-success-loaded-1': 'ÊàêÂäüËºâÂÖ•',
                'msg-success-loaded-2': 'ÂºµÂç°„ÄÇ',
                'err-min-cards': 'ÊÇ®ÂøÖÈ†àËº∏ÂÖ•Ëá≥Â∞ë‰∏ÄÂºµÊúâÊïàÁöÑË™çÂ≠óÂç° (Ë°ìË™û | ÂÆöÁæ©)„ÄÇ',
                // --- Sharing additions ---
                'share-modal-title': 'ÂàÜ‰∫´ÊÇ®ÁöÑÂç°Áâá',
                'share-message': 'ÁúãÁúãÊàëÂÅöÁöÑÈÄô‰∫õË™çÂ≠óÂç°ÔºÅÈªûÊìäÈÄ£ÁµêÂç≥ÂèØÈñãÂßãÂõûÈ°ß: ',
                'share-copy': 'Ë§áË£ΩÈÄ£Áµê',
                'share-whatsapp': 'ÈÄèÈÅé WhatsApp ÂàÜ‰∫´',
                'share-signal': 'ÈÄèÈÅé Signal ÂàÜ‰∫´',
                'share-sms': 'ÈÄèÈÅé SMS ÂàÜ‰∫´',
                'share-facebook': 'ÈÄèÈÅé Facebook ÂàÜ‰∫´',
                'share-telegram': 'ÈÄèÈÅé Telegram ÂàÜ‰∫´',
                'button-close': 'ÈóúÈñâ'
            }
        };

        // --- THEME CONFIGURATIONS (Now includes 5 themes) ---
        const themeConfig = {
            'pro': {
                primary: 'bg-indigo-600 hover:bg-indigo-700 text-white',
                secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                cardFrontText: 'text-indigo-600',
                cardBackBg: 'bg-indigo-50',
                titleColor: 'text-gray-800',
                completionColor: 'text-indigo-600',
                completionIcon: 'üéâ',
                shareBg: 'bg-indigo-600 hover:bg-indigo-700',
                icon: 'üåô'
            },
            'kid': {
                primary: 'bg-teal-500 hover:bg-teal-600 text-white',
                secondary: 'bg-pink-300 text-pink-900 hover:bg-pink-400',
                cardFrontText: 'text-pink-500',
                cardBackBg: 'bg-yellow-100',
                titleColor: 'text-teal-700',
                completionColor: 'text-teal-600',
                completionIcon: 'üöÄ',
                shareBg: 'bg-teal-500 hover:bg-teal-600',
                icon: 'üéà'
            },
            'dark': {
                primary: 'bg-green-500 hover:bg-green-600 text-gray-900',
                secondary: 'bg-gray-700 text-gray-200 hover:bg-gray-600',
                cardFrontText: 'text-green-400',
                cardBackBg: 'bg-gray-800 text-white', // Card back text is white
                titleColor: 'text-white',
                completionColor: 'text-green-400',
                completionIcon: 'üåÉ',
                shareBg: 'bg-green-500 hover:bg-green-600',
                icon: 'üåë'
            },
            'bw': {
                primary: 'bg-black hover:bg-gray-800 text-white border-2 border-black',
                secondary: 'bg-white text-black hover:bg-gray-100 border-2 border-black',
                cardFrontText: 'text-black',
                cardBackBg: 'bg-gray-100 text-black',
                titleColor: 'text-black',
                completionColor: 'text-black',
                completionIcon: '‚¨ú',
                shareBg: 'bg-black hover:bg-gray-800',
                icon: '‚ôüÔ∏è'
            },
            'rainbow': {
                primary: 'bg-fuchsia-500 hover:bg-fuchsia-600 text-white',
                secondary: 'bg-sky-400 text-white hover:bg-sky-500',
                cardFrontText: 'text-red-600',
                cardBackBg: 'bg-yellow-100 text-indigo-800',
                titleColor: 'text-indigo-800',
                completionColor: 'text-fuchsia-600',
                completionIcon: 'üåà',
                shareBg: 'bg-fuchsia-500 hover:bg-fuchsia-600',
                icon: 'üíñ'
            }
        };


        // --- DOM ELEMENTS ---
        const body = document.body;
        const pageTitle = document.getElementById('page-title');
        const homeButton = document.getElementById('home-button');
        const languageToggleButton = document.getElementById('language-toggle-button');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const themeIcon = document.getElementById('theme-icon');
        const fontSmallerButton = document.getElementById('font-smaller-button');
        const fontLargerButton = document.getElementById('font-larger-button');
        const appContainer = document.getElementById('app-container');
        const mainTitle = document.getElementById('main-title');
        const completionScreen = document.getElementById('completion-screen');
        const completionTitle = document.getElementById('completion-title');
        const completionText = document.getElementById('completion-text');
        const completionIcon = document.getElementById('completion-icon');
        const flashcardWrapper = document.getElementById('flashcard-wrapper');
        const flashcardFrontP = document.getElementById('flashcard-front').querySelector('p');
        const flashcardBackP = document.getElementById('flashcard-back').querySelector('p');
        const flashcardFrontDiv = document.getElementById('flashcard-front');
        const flashcardBackDiv = document.getElementById('flashcard-back');
        const progressIndicator = document.getElementById('progress-indicator');
        const startButton = document.getElementById('start-button');
        const editButton = document.getElementById('edit-button');
        const shareButton = document.getElementById('share-button');
        const tryAgainButton = document.getElementById('try-again-button');
        const startOverButton = document.getElementById('start-over-button'); 
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalInstruction = document.getElementById('modal-instruction');
        const editTextArea = document.getElementById('edit-textarea');
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');
        const controls = document.getElementById('controls');
        
        // --- New Sharing Modal Elements ---
        const shareModal = document.getElementById('share-modal');
        const shareModalTitle = document.getElementById('share-modal-title');
        const shareOptions = document.getElementById('share-options');
        const closeShareModalButton = document.getElementById('close-share-modal-button');


        // --- LANGUAGE & THEME FUNCTIONS ---
        
        function updateLanguage() {
            const lang = currentLanguage;

            // Page Title
            pageTitle.textContent = translations[lang]['title'];

            // Main App Text
            mainTitle.textContent = translations[lang]['main-title'];

            startButton.textContent = translations[lang]['button-start'];
            editButton.textContent = translations[lang]['button-edit'];
            
            // Completion Screen
            completionTitle.textContent = translations[lang]['completion-title'];
            completionText.textContent = translations[lang]['completion-text'];
            tryAgainButton.textContent = translations[lang]['button-try-again'];
            startOverButton.textContent = translations[lang]['button-edit']; // Start Over button acts as Edit
            
            // Edit Modal
            modalTitle.textContent = translations[lang]['modal-title'];
            modalInstruction.textContent = translations[lang]['modal-instruction'];
            saveButton.textContent = translations[lang]['button-save'];
            cancelButton.textContent = translations[lang]['button-cancel'];
            
            // Share Modal
            closeShareModalButton.textContent = translations[lang]['button-close'];

            // Update Language Toggle text
            languageToggleButton.textContent = lang === 'en' ? '‰∏≠/En' : 'En/‰∏≠';

            // Update Launch Card and Progress
            resetToLaunchState(false); // Only update text, not full reset
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'zh-TW' : 'en';
            localStorage.setItem(LANG_KEY, currentLanguage);
            updateLanguage();
        }

        function applyTheme(theme) {
            const config = themeConfig[theme];
            
            // 1. Update Body Class
            body.classList.remove(...THEME_CYCLE.map(t => `theme-${t}`));
            body.classList.add(`theme-${theme}`);
            
            // 2. Update Dynamic Buttons
            const buttonsToStyle = [startButton, tryAgainButton, saveButton];
            const secondaryButtons = [editButton, startOverButton];

            // Primary Buttons (Start, Save, Try Again)
            buttonsToStyle.forEach(btn => {
                // Clear and apply new classes for primary button style
                btn.className = `px-6 py-3 font-semibold rounded-xl shadow-lg transition duration-200 transform hover:scale-105 ${config.primary}`;
            });

            // Secondary Buttons (Edit, Start Over)
            secondaryButtons.forEach(btn => {
                // Clear and apply new classes for secondary button style
                btn.className = `px-6 py-3 font-semibold rounded-xl shadow-md transition duration-200 transform hover:scale-105 ${config.secondary}`;
            });

            // Share Button
            shareButton.className = `fixed bottom-6 right-6 z-40 w-14 h-14 flex items-center justify-center text-white rounded-full shadow-xl transition duration-200 transform hover:scale-110 ${config.shareBg}`;
            shareButton.innerHTML = getShareSVG();

            // Card Styling
            // 3. Clear all old theme classes before applying new ones
            flashcardFrontP.className = 'font-extrabold transition duration-300';
            flashcardFrontP.classList.add(config.cardFrontText);
            
            flashcardBackDiv.className = 'flashcard-back';
            // FIX: Split multi-class string from config.cardBackBg before adding.
            flashcardBackDiv.classList.add(...config.cardBackBg.split(' ').filter(c => c));
            
            flashcardFrontDiv.className = 'flashcard-front';
            flashcardFrontDiv.classList.add('bg-white'); // Front card is always white/light for readability

            // App title color (Remove all previous text colors and apply new one)
            mainTitle.classList.remove(...Object.values(themeConfig).map(c => c.titleColor));
            mainTitle.classList.add(config.titleColor);

            // Completion Screen & Theme Icon
            completionTitle.className = `text-4xl font-extrabold mb-3 ${config.completionColor}`;
            completionIcon.textContent = config.completionIcon;
            themeIcon.textContent = config.icon; 
        }
        
        function toggleTheme() {
            const currentIndex = THEME_CYCLE.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % THEME_CYCLE.length;
            currentTheme = THEME_CYCLE[nextIndex];
            localStorage.setItem(THEME_KEY, currentTheme);
            applyTheme(currentTheme);
        }

        // --- URL SHARING LOGIC (UTF-8 SAFE) ---

        /**
         * Converts a string to Base64 using a UTF-8 safe pipeline.
         */
        function utf8_to_b64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                })
            );
        }

        /**
         * Decodes a Base64 string back to a UTF-8 string.
         */
        function b64_to_utf8(str) {
            try {
                 return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch(e) {
                console.error("B64 decoding failed:", e);
                return "";
            }
        }


        /**
         * Converts the current cards array into a Base64-encoded URL-safe string.
         */
        function encodeCards(cards) {
            const cardStrings = cards.map(c => `${c.term}|${c.definition}`);
            const jsonString = JSON.stringify(cardStrings);
            return utf8_to_b64(jsonString); 
        }

        /**
         * Decodes a Base64 string from the URL back into a cards array.
         */
        function decodeCards(encodedData) {
            try {
                if (!encodedData) return [];
                const jsonString = b64_to_utf8(encodedData);
                if (!jsonString) return [];
                
                const cardStrings = JSON.parse(jsonString);
                
                const decodedCards = [];
                cardStrings.forEach(line => {
                    // Split only on the first pipe
                    const parts = line.split(/\|(.*)/s).map(p => p.trim());
                    if (parts.length >= 2 && parts[0]) { 
                        decodedCards.push({ term: parts[0], definition: parts[1] || '' });
                    }
                });
                
                return decodedCards;

            } catch (e) {
                console.error('Failed to decode cards from URL:', e);
                return [];
            }
        }
        
        /**
         * Checks the URL for a shared list and loads it.
         */
        function loadCardsFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            
            if (encodedData) {
                const decoded = decodeCards(encodedData);
                if (decoded.length > 0) {
                    cards = decoded;
                    
                    // Clean the URL by removing the 'data' parameter to prevent accidental refresh loops
                    const cleanUrl = new URL(window.location.href.split('?')[0]); 
                    window.history.replaceState({}, document.title, cleanUrl.pathname);
                    
                    return true;
                }
            }
            return false;
        }

        /**
         * Generates the complete shareable URL with the current card data encoded.
         */
        function getShareableUrl() {
            const encodedData = encodeCards(cards);
            // Use base URL without existing params before adding 'data'
            const url = new URL(window.location.href.split('?')[0]); 
            url.searchParams.set('data', encodedData);
            return url.href;
        }

        // --- STORAGE AND INITIALIZATION ---

        function loadInitialState() {
            // Load Language
            currentLanguage = localStorage.getItem(LANG_KEY) || (navigator.language.includes('zh') ? 'zh-TW' : 'en');
            // Load Theme
            const storedTheme = localStorage.getItem(THEME_KEY);
            currentTheme = (storedTheme && THEME_CYCLE.includes(storedTheme)) ? storedTheme : 'pro';
            
            applyTheme(currentTheme);
            updateLanguage();

            // Load Cards (URL has highest priority)
            if (!loadCardsFromUrl()) {
                try {
                    const storedCards = localStorage.getItem(STORAGE_KEY);
                    cards = storedCards ? JSON.parse(storedCards) : DEFAULT_CARDS;
                    if (!Array.isArray(cards) || cards.length === 0) {
                        cards = DEFAULT_CARDS;
                    }
                } catch (error) {
                    console.error('Error loading cards from localStorage, using defaults:', error);
                    cards = DEFAULT_CARDS;
                }
            }
        }
        
        function saveCards() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
            } catch (error) {
                console.error('Error saving cards to localStorage:', error);
            }
        }

        // --- FONT SIZE LOGIC ---

        function loadFontSize() {
            try {
                const storedSize = localStorage.getItem(FONT_SIZE_KEY);
                currentTermFontSize = storedSize ? parseInt(storedSize) : BASE_FONT_SIZE_PX;
            } catch (e) {
                console.error('Could not load font size, using default.', e);
                currentTermFontSize = BASE_FONT_SIZE_PX;
            }
            applyFontSize();
        }

        function applyFontSize() {
            // Ensure font size is within limits
            currentTermFontSize = Math.max(MIN_FONT_SIZE_PX, Math.min(MAX_FONT_SIZE_PX, currentTermFontSize));

            const definitionSize = Math.max(MIN_FONT_SIZE_PX - DEFINITION_OFFSET_PX, currentTermFontSize - DEFINITION_OFFSET_PX);
            
            // Apply inline style to the paragraph elements inside the card
            flashcardFrontP.style.fontSize = `${currentTermFontSize}px`;
            flashcardBackP.style.fontSize = `${definitionSize}px`;

            // Save for persistence
            localStorage.setItem(FONT_SIZE_KEY, currentTermFontSize);
            
            // Update button states (disable/style when limits are reached)
            fontSmallerButton.disabled = currentTermFontSize <= MIN_FONT_SIZE_PX;
            fontLargerButton.disabled = currentTermFontSize >= MAX_FONT_SIZE_PX;
            
            fontSmallerButton.classList.toggle('opacity-50', fontSmallerButton.disabled);
            fontLargerButton.classList.toggle('opacity-50', fontLargerButton.disabled);
        }

        function increaseFontSize() {
            currentTermFontSize += FONT_STEP_PX;
            applyFontSize();
        }

        function decreaseFontSize() {
            currentTermFontSize -= FONT_STEP_PX;
            applyFontSize();
        }

        /**
         * The Fisher-Yates (Knuth) Shuffle algorithm.
         */
        function shuffle(length) {
            const indices = Array.from({ length }, (_, i) => i);
            for (let i = length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return indices;
        }

        // --- GAME LOGIC ---

        /**
         * Resets the UI to the initial launch state (before review starts).
         */
        function resetToLaunchState(fullReset = true) {
            if(fullReset) {
                completionScreen.classList.add('hidden');
                editModal.classList.add('hidden');
                shareModal.classList.add('hidden'); // Close share modal too
                appContainer.classList.remove('hidden');
                controls.classList.remove('hidden');
                progressIndicator.classList.add('opacity-0');
                flashcardWrapper.classList.remove('flipped');
                currentCardIndex = -1;
                isFlipped = false;
            }

            // Set initial card content
            const lang = currentLanguage;
            
            // Clear all old theme classes before applying new ones
            flashcardFrontP.className = 'font-extrabold transition duration-300';
            flashcardFrontP.classList.add(themeConfig[currentTheme].cardFrontText);
            
            flashcardFrontP.innerHTML = `${translations[lang]['card-launch-start']} <br> (${cards.length} ${translations[lang]['card-launch-loaded']})`;
            flashcardBackP.textContent = translations[lang]['modal-instruction'];
        }

        function startReview() {
            const lang = currentLanguage;

            if (cards.length === 0) {
                flashcardFrontP.innerHTML = translations[lang]['err-empty-cards'].replace(/\n/g, '<br>');
                flashcardFrontP.classList.remove(themeConfig[currentTheme].cardFrontText);
                flashcardFrontP.classList.add('text-red-500');
                controls.classList.remove('hidden');
                return;
            }

            // Reset state
            shuffledIndices = shuffle(cards.length);
            currentCardIndex = 0;
            isFlipped = false;

            // Update UI visibility
            completionScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            controls.classList.add('hidden');
            progressIndicator.classList.remove('opacity-0');

            // Show first card
            displayCurrentCard();
        }

        /**
         * Displays the current card based on the shuffled index.
         */
        function displayCurrentCard() {
            const actualIndex = shuffledIndices[currentCardIndex];
            const card = cards[actualIndex];

            // 1. CLEAR CONTENT AND RESET FLIP STATE INSTANTLY (Flicker Fix)
            flashcardBackP.textContent = ''; 
            flashcardWrapper.classList.remove('flipped');
            isFlipped = false;

            // 2. Set front content instantly (using textContent for review cards)
            flashcardFrontP.textContent = card.term;
            
            // 3. Update definition only AFTER the card has fully rotated back to the front face.
            setTimeout(() => {
                 flashcardBackP.textContent = card.definition;
            }, CARD_TRANSITION_TIME_MS); 

            // Update progress
            const lang = currentLanguage;
            progressIndicator.textContent = `${translations[lang]['progress-indicator-card']} ${currentCardIndex + 1} ${translations[lang]['progress-indicator-of']} ${cards.length}`;
            progressIndicator.classList.remove('text-red-500');
            progressIndicator.classList.add('text-gray-500');
        }

        /**
         * Handles the main click action on the card.
         */
        function handleCardClick() {
            if (currentCardIndex === -1) {
                // If in launch state, click to start review.
                startReview();
                return;
            }

            if (!isFlipped) {
                // 1. Flip the card to show definition
                flashcardWrapper.classList.add('flipped');
                isFlipped = true;
            } else {
                // 2. Advance to the next card
                currentCardIndex++;
                if (currentCardIndex < cards.length) {
                    // Show next card
                    displayCurrentCard();
                } else {
                    // Review is complete
                    showCompletionScreen();
                }
            }
        }

        /**
         * Shows the completion message and resets UI state.
         */
        function showCompletionScreen() {
            appContainer.classList.add('hidden');
            completionScreen.classList.remove('hidden');
            currentCardIndex = -1; // Indicate game over
        }
        
        /**
         * SVG for the Share Icon
         */
        function getShareSVG() {
            return `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" enable-background="new 0 0 50 50">
                <path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/><path d="M24 7h2v21h-2z"/><path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-.6 0-1 .4-1 1v18c0 .6.4 1 1 1h20c.6 0 1-.4 1-1V19c0-.6-.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/>
                </svg>`;
        }


        /**
         * Fallback function to copy text to clipboard using document.execCommand('copy').
         */
        function copyToClipboardFallback(text) {
            const lang = currentLanguage;
            const dummy = document.createElement('textarea');
            dummy.style.position = 'fixed'; 
            dummy.style.opacity = '0';
            dummy.value = text;
            document.body.appendChild(dummy);
            dummy.select();
            try {
                document.execCommand('copy');
                displayMessage(translations[lang]['msg-copy-success'], false);
            } catch (err) {
                displayMessage(translations[lang]['msg-copy-fail'], true);
                console.error("Share URL:", text);
            }
            document.body.removeChild(dummy);
        }
        
        /**
         * Opens the sharing options modal.
         */
        function openShareModal() {
            const lang = currentLanguage;
            const shareUrl = getShareableUrl();
            const message = translations[lang]['share-message'] + shareUrl;

            shareModalTitle.textContent = translations[lang]['share-modal-title'];

            // Define sharing platforms and their configurations
            const platforms = [
                // Icon, Name, URL scheme, Tailwind Color classes
                { icon: 'üì±', name: 'WhatsApp', url: `whatsapp://send?text=${encodeURIComponent(message)}`, color: 'bg-green-500 hover:bg-green-600' },
                { icon: '‚úàÔ∏è', name: 'Telegram', url: `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(translations[lang]['share-message'].trim())}`, color: 'bg-sky-400 hover:bg-sky-500' },
                { icon: 'üìò', name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, color: 'bg-blue-700 hover:bg-blue-800' },
                { icon: 'üîí', name: 'Signal', url: `signal://send?text=${encodeURIComponent(message)}`, color: 'bg-blue-600 hover:bg-blue-700' },
                { icon: '‚úâÔ∏è', name: 'SMS', url: `sms:?body=${encodeURIComponent(message)}`, color: 'bg-gray-700 hover:bg-gray-800' }
            ];

            shareOptions.innerHTML = ''; // Clear previous options

            // 1. Add the Copy Link option (always present)
            const copyBtn = document.createElement('button');
            copyBtn.id = 'share-copy-link';
            copyBtn.className = `w-full px-4 py-3 font-semibold rounded-xl transition duration-200 text-white flex items-center justify-center ${themeConfig[currentTheme].primary}`;
            copyBtn.innerHTML = `${translations[lang]['share-copy']} <span class="ml-2">üìã</span>`;
            copyBtn.addEventListener('click', () => {
                copyToClipboardFallback(shareUrl);
                closeShareModal();
            });
            shareOptions.appendChild(copyBtn);

            // 2. Add platform sharing links
            platforms.forEach(platform => {
                const link = document.createElement('a');
                link.href = platform.url;
                link.target = '_blank'; // Open in a new tab/app
                // Use platform-specific colors
                link.className = `w-full px-4 py-3 font-semibold rounded-xl transition duration-200 text-white flex items-center justify-center ${platform.color}`;
                // Using platform.name for dynamic translation key look-up
                link.innerHTML = `${platform.icon} <span class="ml-2">${translations[lang][`share-${platform.name.toLowerCase()}`]}</span>`;
                shareOptions.appendChild(link);
            });

            shareModal.classList.remove('hidden');
        }

        function closeShareModal() {
            shareModal.classList.add('hidden');
        }

        /**
         * Handles the share button click (now opens the modal).
         */
        function handleShare() {
            const lang = currentLanguage;

            if (cards.length === 0) {
                displayMessage(translations[lang]['err-empty-share'], true);
                return;
            }
            
            openShareModal();
        }

        // --- EDITING LOGIC ---

        /**
         * Utility function to display a temporary message/error using the progress indicator.
         */
        function displayMessage(text, isError = false) {
            progressIndicator.textContent = text;
            progressIndicator.classList.remove('opacity-0', 'text-gray-500', 'text-red-500');
            progressIndicator.classList.add(isError ? 'text-red-500' : 'text-gray-500');
            
            progressIndicator.classList.remove('opacity-0'); 
            
            setTimeout(() => {
                progressIndicator.classList.add('opacity-0');
            }, 5000);
        }

        /**
         * Opens the editing modal and populates the textarea.
         */
        function openEditModal() {
            const textContent = cards.map(c => `${c.term} | ${c.definition}`).join('\n');
            editTextArea.value = textContent;
            editModal.classList.remove('hidden');
        }

        /**
         * Closes the editing modal.
         */
        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        /**
         * Saves the cards from the textarea.
         */
        function handleSaveCards() {
            const rawText = editTextArea.value.trim();
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const lang = currentLanguage;

            const newCards = [];
            let errorCount = 0;

            lines.forEach(line => {
                // Split only on the first pipe
                const parts = line.split(/\|(.*)/s).map(p => p.trim());
                if (parts.length >= 2 && parts[0]) { 
                    newCards.push({ term: parts[0], definition: parts[1] || '' });
                } else {
                    errorCount++;
                    console.warn(`Skipping invalid line: "${line}"`);
                }
            });

            if (newCards.length > 0) {
                cards = newCards;
                saveCards();
                closeEditModal();
                
                // Reset to launch state and show confirmation message
                resetToLaunchState(); 
                
                if (errorCount > 0) {
                    displayMessage(`${newCards.length} ${translations[lang]['msg-success-loaded-2']} ${errorCount} ${translations[lang]['msg-invalid-skipped-1']}`, false);
                } else {
                    displayMessage(`${translations[lang]['msg-success-loaded-1']} ${cards.length} ${translations[lang]['msg-success-loaded-2']}`, false);
                }

            } else {
                displayMessage(translations[lang]['err-min-cards'], true);
            }
        }


        // --- EVENT LISTENERS ---

        // Home button returns to launch state
        homeButton.addEventListener('click', () => resetToLaunchState(true));

        // Language and Theme Toggles
        languageToggleButton.addEventListener('click', toggleLanguage);
        themeToggleButton.addEventListener('click', toggleTheme);

        // Font size controls
        fontSmallerButton.addEventListener('click', decreaseFontSize);
        fontLargerButton.addEventListener('click', increaseFontSize);

        // Start/Try Again buttons
        startButton.addEventListener('click', startReview);
        tryAgainButton.addEventListener('click', startReview);
        
        // Edit Cards buttons (main page and completion page)
        editButton.addEventListener('click', openEditModal);
        startOverButton.addEventListener('click', () => { // "Edit Cards" on completion screen
            completionScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            controls.classList.remove('hidden');
            openEditModal();
        });

        // Share Button (Now opens the modal)
        shareButton.addEventListener('click', handleShare);
        closeShareModalButton.addEventListener('click', closeShareModal);


        // Card navigation (Click anywhere on the card container)
        flashcardWrapper.addEventListener('click', handleCardClick);

        // Edit Modal controls
        cancelButton.addEventListener('click', closeEditModal);
        saveButton.addEventListener('click', handleSaveCards);


        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialState();
            loadFontSize(); // Load and apply font size preference
            resetToLaunchState(); // Ensure the app starts in the correct state
        });

    </script>
</body>
</html>
